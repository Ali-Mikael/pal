# Project VirtualPrivateLab
**Description**
- A basic virtual private lab that you can easily set up and modify for your own purposes.
<br>

**Prerequisites**
- Computer
- Vagrant
- VirtualBox
<br> 

# How to use
Navigate to your designated terminal and run   
```
$ git clone git@github.com:Ali-Mikael/VirtualPrivateLab.git
```
While inside the directory. Run: `vagrant up` <br> 
The repository can be found for inspection on <https://github.com/Ali-Mikael/VirtualPrivateLab> 
<br> 

# Breaking it down
Step 1: Created git repository `VirtualPrivateLab` on my computer. <br> 
Step 2: Created a vagrantfile and the salt directory. <br> 
Step 3: Configure, configure, configure.

#### Vagrant:
- Creates 1 `salt-master` & 3x `salt-minion`
- The minions are created inside a for loop for scalability
- Configures private networking.
  - Set Master IP-address = network prefix + `.100`
  - Minions will get = address prefix + `.10x`
- As this is a lab setup and not production, the master will auto-accept all minion keys.
- There is an option in the `vagrantfile` to use salt bootstrap for installation instead of the `apt` method. This is a lightweight bare down version of salt installation and many modules need manual installing if used.
- The VirtuaBox synced folder (using the VBGuestAdditions) initially caused me some problems. So I went ahead and disabled it completely and now using Vagrant's own `rsync`. More portable and robust this way. Only problem is you have to manually reboot with `$ vagrant reload master` to apply changes if modifying configs on your host computer. Not a huge problem tho and we've lived through worse! And besides, like I said, it's more robust this way, as it works better most of the times and better compatibility with different distributions/versions. 
  - Disable folder globally `config.vm.synced_folder ".", "/vagrant", disabled: true`
  - Using `config.vm.synced_folder "./files", "/home/vagrant/files", type: "rsync", rsync__auto: true` instead
  - The above mentioned folder will among other things be used to transfer the saltproject public key to the VMs.
  - Use rsync for /srv/salt & /srv/pillar
    - `master.vm.synced_folder "./salt", "/srv/salt", type: "rsync", rsync__auto: true`
    - `master.vm.synced_folder "./pillar", "/srv/pillar", type: "rsync", rsync__auto: true`
- The Vagrantfile is heavily commented for readability so the rest you can figure out from there!

The file in question <br> 

```
# -*- mode: ruby -*-
# vi: set ft=ruby :


# Basic setup script for all VMs
# ------------------------------
$initscript = <<-'INITSCRIPT'
  set -o verbose
  apt update && apt upgrade -y
  apt install -y curl tree gnupg
INITSCRIPT


# Install Salt
# ---------------

# Using bootstrap method
$salt_install_bootstrap = <<-'SCRIPT'
  # If using bootstrap method remove "apt install" from the Minion/Master script
  # See https://docs.saltproject.io/salt/install-guide/en/latest/ for more
  curl -o bootstrap-salt.sh -L https://github.com/saltstack/salt-bootstrap/releases/latest/download/bootstrap-salt.sh
  sh bootstrap-salt.sh -P
SCRIPT


# Using APT
$salt_install_apt = <<-'SCRIPT'
  # Ensure keyrings dir exists
  mkdir -p /etc/apt/keyrings

  # Copy SaltProject pub key to keyrings dir  
  cp /home/vagrant/files/SaltProjectKey.gpg.pub /etc/apt/keyrings/salt-archive-keyring.pgp

  # Create apt repo target configuration
  curl -fsSL https://github.com/saltstack/salt-install-guide/releases/latest/download/salt.sources | sudo tee /etc/apt/sources.list.d/salt.sources > /dev/null

  # Update metadata
  apt update
SCRIPT

# Salt-Minion setup script
# ------------------------
$minion = <<-'MINION'
  # Install the salt-minion
  apt install salt-minion -y

  # Configure Master contact details and hostname for the minion
  echo "master: 192.168.88.100" >> /etc/salt/minion
  echo "id: $(hostname)" >> /etc/salt/minion

  # Enable and restart service for configs to take place
  systemctl enable salt-minion && systemctl restart salt-minion
MINION


# Salt-Master setup script
# ------------------------
$master = <<-'MASTER'
  # Installing salt-master
  apt install salt-master -y

  # Specifying the masters ip-address to the config file and auto accepting minion-keys
  # Note: Auto accepting should only be done in test/dev environments, not for production!
  echo "interface: 192.168.88.100" >> /etc/salt/master
  echo "auto_accept: True" >> /etc/salt/master

  # Creating the file_roots path for salt and telling it where to look
  mkdir -p /srv/salt
  echo "file_roots:" >> /etc/salt/master.d/file_roots.conf
  echo "  base:" >> /etc/salt/master.d/file_roots.conf
  echo "    - /srv/salt" >> /etc/salt/master.d/file_roots.conf

  # Ensuring correct permissions
  chown root:root /srv/salt
  chmod 755 /srv/salt

  # Doing the same for pillar
  mkdir -p /srv/pillar
  echo "pillar_roots:" >> /etc/salt/master.d/pillar_roots.conf
  echo "  base:" >> /etc/salt/master.d/pillar_roots.conf
  echo "    - /srv/pillar" >> /etc/salt/master.d/pillar_roots.conf

  # Ensuring correct permissions
  chown root:root /srv/pillar
  chmod 755 /srv/pillar

  # Enable and restart for configs to take place
  systemctl enable salt-master && systemctl restart salt-master
MASTER



# Vagrant configuration for the VMS
# ----------------------------------- 

Vagrant.configure("2") do |config|
	
	# Using Bento's ubuntu 24.04 for the base box
        # Find the box that best suits your needs at:
	# https://portal.cloud.hashicorp.com/vagrant/discover
	config.vm.box = "bento/ubuntu-24.04"

        # Disable VBox shared folder (using rsync instead)
        config.vm.synced_folder ".", "/vagrant", disabled: true
	
	# Syncing /files folder from the repo to vms
	config.vm.synced_folder "./files", "/home/vagrant/files", type: "rsync", rsync__auto: true

	# Virtualbox specific configurations for VMs
	config.vm.provider "virtualbox" do |vb|
	  vb.linked_clone = true	# Use linked for more agile/speedy VM creation
	  vb.memory = 1024		# Set 1024mb of RAM
	  vb.cpus = 2			# Number of CPUs = 2
	end

	
	# Defining the Salt-master
	# ------------------------
	config.vm.define "master" do |master|
	  master.vm.hostname = "master"
	  master.vm.network "private_network", ip: "192.168.88.100"

          # Syncing salt & pillar directories to salt-master
          # Use rsync instead of VBoxAdditions syncing
          master.vm.synced_folder "./salt", "/srv/salt", type: "rsync", rsync__auto: true
	  master.vm.synced_folder "./pillar", "/srv/pillar", type: "rsync", rsync__auto: true

	  # Provision the master VM
	  master.vm.provision "shell", inline: $initscript
          master.vm.provision "shell", inline: $salt_install_apt
	  master.vm.provision "shell", inline: $master
	end


	# Defining Salt-minions
        # ---------------------
	minions = {
	"devbox" => "192.168.88.101",
	"web-serv" => "192.168.88.102",
	"db-serv" => "192.168.88.103"
	}

	minions.each do |name, ip|
	  config.vm.define name do |minion|

	    # Configure names and IP-addressing
	    minion.vm.hostname = name
	    minion.vm.network "private_network", ip: ip

	    # Provision each minion VM
	    minion.vm.provision "shell", inline: $initscript
            minion.vm.provision "shell", inline: $salt_install_apt
	    minion.vm.provision "shell", inline: $minion
	  end
	end
end

``` 

# Initialize infrastructure
<img width="692" alt="Screenshot 2025-05-06 at 18 38 07" src="https://github.com/user-attachments/assets/c08a7c75-5d8d-4000-b35d-5e5cc233e553" /> <br> 

# Connection test
<img width="472" alt="Screenshot 2025-05-06 at 19 01 43" src="https://github.com/user-attachments/assets/44939584-aec7-41ec-a25f-b52dd98a6416" /> <br> 

# The file_roots structure:
<img width="771" alt="Screenshot 2025-05-06 at 19 18 00" src="https://github.com/user-attachments/assets/dbedfcd1-783b-48b7-bc82-66b5b446b837" />

```
/srv/salt
├── common
│   ├── files
│   │   └── ssh
│   │       └── sshd_config
│   ├── git.sls
│   └── ssh.sls
├── firewall
│   ├── dbserv.sls
│   ├── devbox.sls
│   ├── init.sls
│   └── webserv.sls
├── lang
│   ├── init.sls
│   ├── java.sls
│   ├── nodejs.sls
│   └── python.sls
├── role
│   ├── dbserv.sls
│   ├── devbox.sls
│   └── webserv.sls
├── service
│   ├── apache
│   │   ├── init.sls
│   │   └── sites
│   │       └── index.html
│   ├── docker
│   │   └── init.sls
│   ├── mariadb
│   │   └── init.sls
│   ├── mysql
│   │   └── init.sls
│   └── nginx
│       └── init.sls
├── tool
│   ├── build-essential.sls
│   ├── htop.sls
│   ├── httpie.sls
│   ├── init.sls
│   ├── nmap.sls
│   ├── tcpdump.sls
│   └── tmux.sls
├── top.sls
└── user
    ├── devuser.sls
    └── user1.sls
```

A scalable structure which can easily by expanded and modified to fit ones needs. Having a clear and consistent structure makes it easy to configure different minions for different purposes. <br> 

The environment contains in essence
- A database server running Mariadb
- A webserver running Apache
- A devbox running Docker and some tools to go with the setup
- A lot of room for tailoring and some additional modules/states which are excluded from `highstate`

<br> 

**Q:** What is a "`highstate`"? <br> 
**A:** Highstate --> Applying a set of predefined configurations a.k.a states, to a system, based on mappings in the `top.sls` file, to form a complete definition of a host. <br> 

# Create roles
Step 1: Create a role in the `/srv/salt/role` directory (for example devbox). <br> 
Step 2: Define what you want the box to include.
```
# /srv/salt/role/devbox.sls

# - Define the developer workstation role -

include:
- lang
- tool
- service.docker
- common.ssh
- common.git
``` 
<br> 
Step 3: Map the role to desired minion using the `top.sls` file.

```
# /srv/salt/top.sls

base:

  # Define roles for minions
  # ------------------------
  'devbox':
    - role.devbox
  'web-serv':
    - role.webserv
  'db-serv':
    - role.dbserv
```

<br> 

Now you're able to run the `highstate` for minion(s) with:

```
$ sudo salt '<specify-minion(s)>' state.apply
``` 
Which will then apply all configurations specified within `/role`  <br>  
If you want to know how the current state would change before actually applying it (using `devbox` again for example), simply:
```
$ sudo salt 'devbox' state.apply test=true
```
<img width="913" alt="Screenshot 2025-05-06 at 19 43 03" src="https://github.com/user-attachments/assets/3c8db147-a9ce-460b-99b7-7640858b6a03" /> <br> 
### --- some output retracted ---
<img width="674" alt="Screenshot 2025-05-06 at 19 44 23" src="https://github.com/user-attachments/assets/bebe1321-0835-4178-8388-47ce01aeb177" /> <br> 
**Explanation**
- 16 states were run.
- 8 of them were already in desired state.
- 10 were set to run but left unchanged.

After careful consideration that this is something we actually want to do, we can just go ahead and and apply the changes (for real this time). <br>
Remove the `test=true` (training wheels) and run the same command again. <br> 
<img width="782" alt="Screenshot 2025-05-06 at 19 53 23" src="https://github.com/user-attachments/assets/3fbed2b5-3bac-49f9-a799-f9b4be469fbd" /> <br> 
Want to create a user for the devbox?
- Just create it in the user module and apply it!
<img width="1106" alt="Screenshot 2025-05-06 at 20 28 03" src="https://github.com/user-attachments/assets/669d20ad-8a1e-4cd2-bcfe-6ae888fee869" /> <br>
<img width="808" alt="Screenshot 2025-05-06 at 20 11 21" src="https://github.com/user-attachments/assets/ae95768f-a2e7-4f35-8e3b-d5dec96ba5ba" /> <br>
<img width="309" alt="Screenshot 2025-05-06 at 20 11 34" src="https://github.com/user-attachments/assets/96a6d7a8-5a57-40dc-b9e7-5a2c56514a0a" /> Just like that <br>


**Q:** But is it idempotent? <br> 
Running the same states again:
```
Comment: All specified packages are already installed
```
```
Comment: The service docker is already running
```
```
Comment: File /etc/ssh/sshd_config is in the correct state
```
<img width="321" alt="Screenshot 2025-05-06 at 19 56 45" src="https://github.com/user-attachments/assets/8fad6f1f-f107-4c76-9de7-13a5baf1c778" /> (Pretty hefty runtime difference as well) <br> 
<img width="864" alt="Screenshot 2025-05-06 at 20 32 05" src="https://github.com/user-attachments/assets/2119f438-c018-4aa9-b588-637f3b142894" /> <br> 

### Setting up the web-server
```
$ sudo salt 'web-serv' state.apply
```
<img width="798" alt="Screenshot 2025-05-06 at 20 03 40" src="https://github.com/user-attachments/assets/7f3a4525-f03f-46fc-a3c2-3d5d45b10fda" /> <br> 
<img width="296" alt="Screenshot 2025-05-06 at 20 04 31" src="https://github.com/user-attachments/assets/eaaa1f22-4b9a-4c9e-b1b1-a1e661c18599" /> <br> 
### Making sure changes were actually applied
Checking if the default page has changed.
![Screenshot 2025-05-06 at 20 09 26](https://github.com/user-attachments/assets/b7273105-4b03-4d1c-a05c-244b3c2b81e0) <br> 


# Setting up the database-server
**init.sls:** 
```
# /srv/salt/service/mariadb/init.sls


# Necessary dependency install (for preseeding)
debconf-utils:
  pkg.installed


# Preseed the root password. (to be done before db install)
set_mariadb_root:
  debconf.set:
    - name: mariadb-server
    - data:
        'mysql-server/root_password': {'type': 'password', 'value': {{ salt['pillar.get']('mysql_root', '') }} }
        'mysql-server/root_password_again': {'type': 'password', 'value': {{ salt['pillar.get']('mysql_root', '') }} }
    - require:
      - pkg: debconf-utils

# Install mariadb
#
mariadb_install:
  pkg.installed:
    - pkgs:
      - mariadb-server
      - mariadb-client
    - require:
      - debconf: set_mariadb_root

# Ensure service is running
#
mariadb_service:
  service.running:
    - name: mariadb
    - enable: True
    - require:
      - pkg: mariadb_install
```

### Using pillars for the password
**database.sls:** 
```
# /srv/salt/pillar/database.sls

# NOTE: CHANGE PASSWORD!
mysql_root: "Default1234"
```
**top.sls** 
```
# /srv/salt/pillar/top.sls

base:
  'db-serv':
    - database
```

### Trial run
Running a test to see if we are reaching the pillar correctly
```
$ sudo salt 'db-serv' state.apply test=true
```

```
----------
          ID: set_mariadb_root
    Function: debconf.set
        Name: mariadb-server
      Result: None
     Comment: 
     Started: 13:55:26.422040
    Duration: 90.097 ms
     Changes:   
              ----------
              mysql-server/root_password:
                  New value: Default1234
              mysql-server/root_password_again:
                  New value: Default1234
----------
```

```
Summary for db-serv
------------
Succeeded: 6 (unchanged=3, changed=2)
Failed:    0
------------
Total states run:     6
Total run time:   2.286 s
```

### Removing training wheels
```
$ sudo salt 'db-serv' state.apply
```

This time around we see pillars in action (password hidden)
```
----------
          ID: set_mariadb_root
    Function: debconf.set
        Name: mariadb-server
      Result: True
     Comment: 
     Started: 13:58:33.997710
    Duration: 98.715 ms
     Changes:   
              ----------
              mysql-server/root_password:
                  (password hidden)
              mysql-server/root_password_again:
                  (password hidden)
```



<br> 

# Notes:
The firewall module still needs some working on at the time of writing this 06.05.2025. <br> 
Plans also include adding a pentest box to test out the security of the environment. Updates coming up! <br> 

## Stay tuned! 
<br> 



# Some light reading & a video
Salt Essentials (book) by Craig Sebenik & Thomas Hatch (2015) <br> 
Salt bootsrap - <https://docs.saltproject.io/en/3006/topics/tutorials/salt_bootstrap.html> <br> 
Salt bootstrap download - <https://github.com/saltstack/salt-bootstrap?tab=readme-ov-file#testing-in-vagrant> <br> 
Salt documentation - <https://docs.saltproject.io/en/latest/contents.html> <br> 
Salt pillars - <https://docs.saltproject.io/salt/user-guide/en/latest/topics/pillar.html> <br> 
MySQL preseed - <https://terokarvinen.com/2018/mysql-automatic-install-with-salt-preseed-database-root-password/> <br> 
MySQL state - <https://www.digitalocean.com/community/tutorials/saltstack-infrastructure-creating-salt-states-for-mysql-database-servers> <br> 
Firewalld - <https://docs.saltproject.io/en/latest/ref/states/all/salt.states.firewalld.html#salt.states.firewalld.service> <br> 
SaltStack Configuration Management Best Practices - <https://www.youtube.com/watch?v=RbXnXZu_4ng>







