# Project VirtualPrivateLab
Description
- A basic virtual private lab that you can easily set up and modify for your own purposes. 
<br>
Prerequisites
- Computer
- Vagrant
- VirtualBox
<br> 

# How to use
Navigate to your designated terminal and run   
```
$ git clone git@github.com:Ali-Mikael/VirtualPrivateLab.git
``` 
The repository can be found for inspection on <https://github.com/Ali-Mikael/VirtualPrivateLab> 
<br> 

# Breaking it down
Step 1: Created git repository `VirtualPrivateLab` on my computer. <br> 
Step 2: Created a vagrantfile and the salt directory. <br> 
Step 3: Configure, configure, configure.

#### Vagrantfile:
- Creates 1 `salt-master` & 3x `salt-minion`
- The minions are created inside a for loop for scalability
- Configures private networking.
  - Set Master IP-address = network prefix + `.100`
  - Minions will get = address prefix + `.10x`
- As this is a lab setup and not production, the master will auto-accept all minion keys.
- There is an option in the `vagrantfile` to use salt bootstrap for installation instead of the `apt` method. This is a lightweight bare down version of salt installation and many modules need manual installing if used.
- The VirtuaBox synced folder (using the VBGuestAdditions) initially caused me some problems. So I went ahead and disabled it completely and now using Vagrant's own `rsync`. More portable and robust this way. Only problem is you have to manually reboot with `$ vagrant reload master` to apply changes if modifying configs on your host computer. Not a huge problem tho and we've lived through worse! And besides, like I said, it's more robust this way, as it works better most of the times and better compatibility with different distributions/versions. 
  - Disable folder globally `config.vm.synced_folder ".", "/vagrant", disabled: true`
  - Use rsync for the salt-master ` master.vm.synced_folder "./salt", "/srv/salt", type: "rsync", rsync__auto: true`
- The Vagrantfile is heavily commented for readability so the rest you can figure out from there!

The file in question <br> 
--------------------
```
# -*- mode: ruby -*-
# vi: set ft=ruby :


# Basic setup script for all VMs
# ------------------------------
$initscript = <<-INITSCRIPT
  set -o verbose
  apt update && apt upgrade -y
  apt install -y curl
INITSCRIPT

# Install Salt
# ---------------

$salt_install_bootstrap = <<-SCRIPT
  # If using bootstrap method remove "apt install" from the Minion/Master script
  # See https://docs.saltproject.io/salt/install-guide/en/latest/ for more
  curl -o bootstrap-salt.sh -L https://github.com/saltstack/salt-bootstrap/releases/latest/download/bootstrap-salt.sh
  sh bootstrap-salt.sh -P
SCRIPT

$salt_install_apt = <<-SCRIPT
  # Ensure keyrings dir exists
  mkdir -p /etc/apt/keyrings
  # Download public key
  curl -fsSL https://packages.broadcom.com/artifactory/api/security/keypair/SaltProjectKey/public | sudo tee /etc/apt/keyrings/salt-archive-keyring.pgp
  # Create apt repo target configuration
  curl -fsSL https://github.com/saltstack/salt-install-guide/releases/latest/download/salt.sources | sudo tee /etc/apt/sources.list.d/salt.sources
  apt update
SCRIPT

# Salt-Minion setup script
# ------------------------
$minion = <<-MINION
  # Install the salt-minion
  apt install salt-minion -y

  # Configure Master contact details and hostname for the minion
  echo "master: 192.168.88.100" >> /etc/salt/minion
  echo "id: $(hostname)" >> /etc/salt/minion

  # Enable and restart service for configs to take place
  systemctl enable salt-minion && systemctl restart salt-minion
MINION


# Salt-Master setup script
# ------------------------
$master = <<-MASTER
  # Installing salt-master
  apt install salt-master -y

  # Specifying the masters ip-address to the config file and auto accepting minion-keys
  # Note: Auto accepting should only be done in test/dev environments, not for production!
  echo "interface: 192.168.88.100" >> /etc/salt/master
  echo "auto_accept: True" >> /etc/salt/master

  # Creating the file_roots path for salt and telling it where to look
  mkdir -p /srv/salt
  echo "file_roots:" >> /etc/salt/master.d/file_roots.conf
  echo "  base:" >> /etc/salt/master.d/file_roots.conf
  echo "    - /srv/salt" >> /etc/salt/master.d/file_roots.conf

  # Ensuring /srv/salt has correct permissions
  chown root:root /srv/salt
  chmod 755 /srv/salt

  # Enable and restart for configs to take place
  systemctl enable salt-master && systemctl restart salt-master
MASTER



# Vagrant configuration for the VMS
# ----------------------------------- 

Vagrant.configure("2") do |config|
	
	# Using Bento's ubuntu 24.04 for the base box
	config.vm.box = "bento/ubuntu-24.04"

        # Disable VBox shared folder (using rsync instead)
        config.vm.synced_folder ".", "/vagrant", disabled: true

	# Virtualbox specific configurations for VMs
	config.vm.provider "virtualbox" do |vb|
	  vb.linked_clone = true	# Use linked for more agile/speedy VM creation
	  vb.memory = 1024		# Set 1024mb of RAM
	  vb.cpus = 2			# Number of CPUs = 2
	end

	
	# Defining the Salt-master
	# ------------------------
	config.vm.define "master" do |master|
	  master.vm.hostname = "master"
	  master.vm.network "private_network", ip: "192.168.88.100"

          # Syncing the repo salt folder to salt-master under /srv/salt (the file roots path)
          # Use rsync instead of VBadditions syncing
          master.vm.synced_folder "./salt", "/srv/salt", type: "rsync", rsync__auto: true

	  # Provision the master VM
	  master.vm.provision "shell", inline: $initscript
          master.vm.provision "shell", inline: $salt_install_apt
	  master.vm.provision "shell", inline: $master
	end


	# Defining Salt-minions
        # ---------------------
	minions = {
	"devbox" => "192.168.88.101",
	"web-serv" => "192.168.88.102",
	"db-serv" => "192.168.88.103"
	}

	minions.each do |name, ip|
	  config.vm.define name do |minion|

	    # Configure names and IP-addressing
	    minion.vm.hostname = name
	    minion.vm.network "private_network", ip: ip

	    # Provision each minion VM
	    minion.vm.provision "shell", inline: $initscript
            minion.vm.provision "shell", inline: $salt_install_apt
	    minion.vm.provision "shell", inline: $minion
	  end
	end
end
``` 

# Initialize infrastructure
<img width="692" alt="Screenshot 2025-05-06 at 18 38 07" src="https://github.com/user-attachments/assets/c08a7c75-5d8d-4000-b35d-5e5cc233e553" /> <br> 

# Connection test
<img width="472" alt="Screenshot 2025-05-06 at 19 01 43" src="https://github.com/user-attachments/assets/44939584-aec7-41ec-a25f-b52dd98a6416" /> <br> 

#### The file_roots structure:
<img width="771" alt="Screenshot 2025-05-06 at 19 18 00" src="https://github.com/user-attachments/assets/dbedfcd1-783b-48b7-bc82-66b5b446b837" />

```
/srv/salt
├── common
│   ├── files
│   │   └── ssh
│   │       └── sshd_config
│   ├── git.sls
│   └── ssh.sls
├── firewall
│   ├── db.sls
│   ├── devbox.sls
│   ├── init.sls
│   └── webserv.sls
├── lang
│   ├── init.sls
│   ├── java.sls
│   ├── nodejs.sls
│   └── python.sls
├── role
│   ├── db.sls
│   ├── devbox.sls
│   └── webserv.sls
├── service
│   ├── apache
│   │   ├── init.sls
│   │   └── sites
│   │       └── index.html
│   ├── dbserver
│   │   └── init.sls
│   ├── docker
│   │   └── init.sls
│   └── nginx
│       └── init.sls
├── tool
│   ├── build-essential.sls
│   ├── htop.sls
│   ├── httpie.sls
│   ├── init.sls
│   ├── nmap.sls
│   ├── tcpdump.sls
│   └── tmux.sls
├── top.sls
└── user
    ├── devuser.sls
    ├── init.sls
    └── user1.sls
```

I built a scalable structure which can easily by expanded and modified to fit ones needs. Having a clear and consistent structure makes it easy to configure different minions for different purposes. 

### Create roles
Step 1: Create a role in the /srv/salt/role directory (for example devbox). <br> 
Step 2: Define what you want the box to include. <br> 
<img width="490" alt="Screenshot 2025-05-06 at 19 15 01" src="https://github.com/user-attachments/assets/22b2710c-8319-4306-bf40-94c2cdd3785a" /> <br> 
Step 3: Map the role to desired minion using the `top.sls` file. <br> 
<img width="422" alt="Screenshot 2025-05-06 at 19 19 33" src="https://github.com/user-attachments/assets/a1170ad5-a254-40a3-b99e-e5fb21b9936f" /> <br> 
Now you're able to run the `highstate` for minion(s) with:
```
$ sudo salt '<specify-minion(s)>' state.apply
```
Which will then apply all configurations specified within `/role`  <br>  
If you want to know how the current state would change before actually applying it (using `devbox` again for example), simply:
```
$ sudo salt 'devbox' state.apply test=true
```
<img width="913" alt="Screenshot 2025-05-06 at 19 43 03" src="https://github.com/user-attachments/assets/3c8db147-a9ce-460b-99b7-7640858b6a03" /> <br> 
--- some output retracted --- <br> 
<img width="674" alt="Screenshot 2025-05-06 at 19 44 23" src="https://github.com/user-attachments/assets/bebe1321-0835-4178-8388-47ce01aeb177" /> <br> 
**Explanation**
- 16 states were run.
- 8 of them were already in desired state.
- 10 were set to run but left unchanged.

After careful consideration that this is something we actually want to do, we can just go ahead and and apply the changes (for real this time). <br>
Remove the `test=true` (training wheels) and run the same command again. <br> 
<img width="782" alt="Screenshot 2025-05-06 at 19 53 23" src="https://github.com/user-attachments/assets/3fbed2b5-3bac-49f9-a799-f9b4be469fbd" /> <br> 
Want to create a user for the devbox?
- Just create it in the user module and apply it!
<img width="1106" alt="Screenshot 2025-05-06 at 20 28 03" src="https://github.com/user-attachments/assets/669d20ad-8a1e-4cd2-bcfe-6ae888fee869" /> <br>
<img width="808" alt="Screenshot 2025-05-06 at 20 11 21" src="https://github.com/user-attachments/assets/ae95768f-a2e7-4f35-8e3b-d5dec96ba5ba" /> <br>
<img width="309" alt="Screenshot 2025-05-06 at 20 11 34" src="https://github.com/user-attachments/assets/96a6d7a8-5a57-40dc-b9e7-5a2c56514a0a" /> Just like that <br>


**Q:** But is it idempotent?
Running the same states again: <br> 
(some output retracted again) <br> 
<img width="612" alt="Screenshot 2025-05-06 at 19 56 03" src="https://github.com/user-attachments/assets/afb9ed76-af83-41db-81c8-966f221b3f9e" /> <br> 
<img width="537" alt="Screenshot 2025-05-06 at 19 56 25" src="https://github.com/user-attachments/assets/93ff6cda-53e9-459e-b155-784de3f48e5c" /> <br> 
<img width="660" alt="Screenshot 2025-05-06 at 19 56 35" src="https://github.com/user-attachments/assets/d343d2b5-2365-49a9-80c8-7f4a01b81f80" /> <br> 
<img width="321" alt="Screenshot 2025-05-06 at 19 56 45" src="https://github.com/user-attachments/assets/8fad6f1f-f107-4c76-9de7-13a5baf1c778" /> (Pretty hefty runtime difference as well) <br> 
<img width="864" alt="Screenshot 2025-05-06 at 20 32 05" src="https://github.com/user-attachments/assets/2119f438-c018-4aa9-b588-637f3b142894" /> <br> 

### Setting up the web-server
```
$ sudo salt 'web-serv' state.apply
```
<img width="798" alt="Screenshot 2025-05-06 at 20 03 40" src="https://github.com/user-attachments/assets/7f3a4525-f03f-46fc-a3c2-3d5d45b10fda" /> <br> 
<img width="296" alt="Screenshot 2025-05-06 at 20 04 31" src="https://github.com/user-attachments/assets/eaaa1f22-4b9a-4c9e-b1b1-a1e661c18599" /> <br> 
Let's see if the webserver runs as intended <br> 
![Screenshot 2025-05-06 at 20 09 26](https://github.com/user-attachments/assets/b7273105-4b03-4d1c-a05c-244b3c2b81e0) <br> 
Success!


# Notes:
The firewall module still needs some working on at the time of writing this 06.05.2025. <br> 
Plans also include adding a pentest box to test out security of the environment. <br> 
Updates coming up. <br>  
## Stay tuned! 
<br> 



# Some light reading & a video
Salt bootsrap - <https://docs.saltproject.io/en/3006/topics/tutorials/salt_bootstrap.html> <br> 
Salt bootstrap download - <https://github.com/saltstack/salt-bootstrap?tab=readme-ov-file#testing-in-vagrant> <br> 
SaltStack Configuration Management Best Practices - <ttps://www.youtube.com/watch?v=RbXnXZu_4ng> <br> 
Salt Essentials (book) by Craig Sebenik & Thomas Hatch (2015) <br> 
Salt documentation - <https://docs.saltproject.io/en/latest/contents.html> <br> 
Firewalld - <https://docs.saltproject.io/en/latest/ref/states/all/salt.states.firewalld.html#salt.states.firewalld.service>







