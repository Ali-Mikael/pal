<style>
  body {
    background-color: #1a1a1a;
    color: #e0e0e0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.6;
    padding: 2rem;
  }

  h1, h2, h3, h4, h5, h6 {
    color: #ffffff;
    margin-top: 2rem;
    margin-bottom: 1rem;
  }

  pre {
    background-color: #121212;
    padding: 1rem;
    border-radius: 6px;
    overflow-x: auto;
    box-shadow: 0 0 8px rgba(0, 255, 255, 0.08);
  }

  code {
    background-color: #1f1f1f;
    padding: 0.2em 0.4em;
    border-radius: 4px;
    color: #00ffcc;
  }

  blockquote {
    border-left: 4px solid #444;
    padding-left: 1em;
    color: #aaa;
    font-style: italic;
  }

  img {
    max-width: 100%;
    height: auto;
    border: 2px solid #333;
    border-radius: 8px;
    margin: 1rem 0;
  }

  a {
    color: #00bfff;
    text-decoration: none;
  }

  a:hover {
    text-decoration: underline;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
  }

  th, td {
    border: 1px solid #333;
    padding: 0.5rem;
    text-align: left;
  }

  th {
    background-color: #222;
  }
</style>


# Control Daemons with Salt (summary) - X
> Reference: <https://terokarvinen.com/2018/04/03/pkg-file-service-control-daemons-with-salt-change-ssh-server-port/?fromSearch=karvinen%20salt%20ssh>

#### Create required states for daemons
- Easily control a huge number of daemons with a configuration management system.
- Package -> file -> service is the common pattern.
- **Install software, replace config file, restart daemon**

#### Steps (with salt):
- Create the .sls file. 
- Include in the file:
  - `pkg.installed` - the daemon we want
  - `file.managed` - the configurations we're applying on the daemon
  - `service.running` - make sure daemon is up and running
    - **bonus** - include `- watch: ` with the `service.running` so that salt will restart the service everytime there is a configuration change!
    - This is all about automation after all...
- Once everything is configured in the .sls file on the master. `/srv/salt/<module>/init.sls`. (`<module>` point to the daemon we're configuring, for example SSH, Apache2, UFW etc...)
- We can go ahead use Salt to apply the state our slaves with `$ sudo salt '*' state.apply <module>`. Simple as that! 🙏 
- If you configured the `- watch: ` parameter in you state file with the `service.running`, then every time you make a change to the config file, it should automatically be applied to all your slave without manual intervention.
- I say "should", because we all know computers don't always compute the way we would like them to compute.
  - **Always make sure and never trust blindly!**


# Apache - A
> References:
> - <https://docs.saltproject.io/salt/user-guide/en/latest/topics/requisites.html>
> - <https://terokarvinen.com/palvelinten-hallinta/>
> - <https://docs.saltproject.io/en/latest/topics/tutorials/states_pt2.html>


I used Vagrant to set up 3 virtual machines (1 salt-master & 2 salt-minions).
- Accepting the keys on my master and then doing a quick connection test
  - ![Screenshot 2025-04-21 at 15 12 51](https://github.com/user-attachments/assets/89b85514-c2ca-4a18-80b7-655ea7d6b27b)

### Manual Minion01 
- Apache was not yet present on the system.
  - ![Screenshot 2025-04-21 at 15 18 00](https://github.com/user-attachments/assets/a6eb7553-9778-48c5-aaf9-a3ff3dd6234c)
- Installing apache manually & locally on the minion:
- `$ sudo apt update && sudo apt upgrade -y` and then installing the pkg with `$ sudo apt install apache2`
- Once apache was installed, I located the `index.html` file which is stored under the `/var/www/html/` directory path and edited the default site.
  - ![Screenshot 2025-04-21 at 15 37 16](https://github.com/user-attachments/assets/b2c93bb2-1865-4eb0-bc2d-3ff832cae6e6)
- Once the changes were made, I saved the file and typed my minions IP-address in my browser to see the changes.
  - <img width="1427" alt="Screenshot 2025-04-21 at 15 37 59" src="https://github.com/user-attachments/assets/8f3180fa-f21f-4c2e-ae66-88e2f5584bf6" />

### Automated Minion02 
- Making sure the minion02 doesn't have apache installed already
  - ![Screenshot 2025-04-21 at 15 55 01](https://github.com/user-attachments/assets/b3873bfe-92ab-4581-b563-f6519b937a66)
- On the salt-master, created the `/srv/salt` + the apache module + moved into it + created the state file with the command:
  - `$ sudo mkdir -p /srv/salt/apache && cd /srv/salt/apache && sudo touch init.sls`
  - ![Screenshot 2025-04-21 at 16 14 16](https://github.com/user-attachments/assets/9bb83e96-83cc-40c0-8f91-922900c1e9be)
- **The state file:**
  - ![Screenshot 2025-04-21 at 16 52 20](https://github.com/user-attachments/assets/0cbe43da-bf0a-4bbb-946a-44cd5e8e4a29)
  - `pkg.installed` - installing apache if not already installed
  - `service.running` - making sure that apache is active & running correctly. (by using `require` we're basically giving salt prerequisites for running this state, this is used for a robust and clear configuration)
  - `file.managed` - the website we're providing. `source` tells salt where to find the file we want to use.
  - Created `/files/sites/` under our apache module, where we can then store our html page. This is the directory path for the above mentioned `source`. 
    - ![Screenshot 2025-04-21 at 16 41 54](https://github.com/user-attachments/assets/a6f1f466-077a-4135-ac0a-86b9b28aba78)
- Now we can apply our state `$ sudo salt '*' state.apply apache` and let Salt do the magic.
  - ![Screenshot 2025-04-21 at 16 53 43](https://github.com/user-attachments/assets/cad6aa3b-89a4-49fe-b95e-1aa08efc91cf)
  - ![Screenshot 2025-04-21 at 16 54 12](https://github.com/user-attachments/assets/ea938fc9-b023-4459-b4a8-613ce281efae)
  - ![Screenshot 2025-04-21 at 16 54 35](https://github.com/user-attachments/assets/ae2b634d-9803-46b7-ab61-e214e6a4568d)

**SUMMARY:**
- ![Screenshot 2025-04-21 at 16 55 10](https://github.com/user-attachments/assets/d5b073c7-8b40-48dc-95b4-d46e9b78201b)
    - `pkg.installed` - 1 succeeded & 1 changed - apache was installed.
    - `service.running` - 1 succeeded no change - apache was already in desired state meaning it was already running.
    - `file.managed` - 1 succeeded & 1 changed - the default `index.html` file was updated.
- Typing in `minion02`'s IP-address (192.168.88.102) in the browser to access the website
  - ![Screenshot 2025-04-21 at 17 01 54](https://github.com/user-attachments/assets/a96bf310-c4c8-420a-a5d9-e4d92c943320)


**What this means for my other minion?**
- I typed in `minion01`'s IP-address in the browser and it gave me the same page. 
- `Minion01` had `3 succeeded (changed=1)`, meaning that the state.file was idempotent.
- We previously configured apache2 on the minion01, so only the `index.html` was updated on it `(changed=1).`
> Everything seemed to work as intended, so no further comment here.

# SSH - B












